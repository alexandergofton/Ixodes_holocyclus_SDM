---
title: "05 Validation"
author: "Alexander W. Gofton"
date: today
format:
  gfm:
    toc: true
    toc-depth: 3
  html:
    toc: true
    toc-depth: 3
    code-fold: false
    theme: cosmo
execute:
  warning: false
  message: false
  cache: false
knitr:
  opts_chunk:
    results: hold
---

# 1. Setup and Configuration

```{r setup}
#| cache: false

# --- Core spatial ---
library(terra)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)

# --- Data manipulation ---
library(tidyverse)

# --- SDM fitting ---
#library(maxnet)
#library(randomForest)
#library(gbm)
#library(dismo)
#library(mgcv)

# --- SDM evaluation and tuning ---
#library(blockCV)
#library(ENMeval)
#library(ecospat)

# --- Variable selection ---
#library(corrplot)

# --- Spatial thinning ---
#library(spThin)

# --- Visualisation ---
library(patchwork)
library(viridis)

# --- Set seed for reproducibility ---
set.seed(7990)

# --- Paths ---
base_dir <- "/Users/gof005/Library/CloudStorage/OneDrive-CSIRO/OneDrive - Docs/01_Projects/alpha_gal/02_SAP_2025-6/Ihol_SDM"
data_dir <- file.path(base_dir, "data")
processed_dir <- file.path(base_dir, "processed_data")
output_dir <- file.path(base_dir, "outputs")
figures_dir <- file.path(base_dir, "figures")


# --- Study area extent (Eastern Australia) ---
study_extent <- ext(140, 155, -40, -10)
```

# 2. Load Outputs from Previous Scripts

```{r load-inputs}
#| cache: false

# --- From 02_env_vars.qmd ---
env_all    <- rast(file.path(output_dir, "env_layers", "env_all.tif"))

# --- From 03_bg_points_model_fitting.qmd ---
bg_out_dir   <- file.path(output_dir, "bg_model_inputs")
model_data   <- readRDS(file.path(bg_out_dir, "model_data.rds"))
pred_cols    <- readRDS(file.path(bg_out_dir, "pred_cols.rds"))
algorithms   <- readRDS(file.path(bg_out_dir, "algorithms.rds"))
algo_names   <- readRDS(file.path(bg_out_dir, "algo_names.rds"))
cv_summary   <- read_csv(file.path(output_dir, "cv_performance_summary.csv"),
                         show_col_types = FALSE)

# --- From 04_full_model_fitting.qmd ---
sdm_out_dir    <- file.path(output_dir, "sdm_results")
ensemble_binary <- rast(file.path(sdm_out_dir, "ensemble_binary.tif"))
weights         <- readRDS(file.path(sdm_out_dir, "ensemble_weights.rds"))
tss_result      <- readRDS(file.path(sdm_out_dir, "tss_result.rds"))

cat("Loaded all inputs for validation.\n")
```

# 11. Ecological Validation

```{r ecological-validation}
#| label: ecological-validation

# --- Check against known physiological thresholds ---

# Extract environmental values at predicted suitable locations
suitable_cells <- as.data.frame(ensemble_binary, xy = TRUE, na.rm = TRUE)
suitable_cells <- suitable_cells[as.integer(suitable_cells[[3]]) == 1L, ]
suitable_vect <- vect(suitable_cells[, 1:2], geom = c("x", "y"), crs = "EPSG:4326")
suitable_env <- terra::extract(env_all, suitable_vect)

cat("=== Ecological Validation ===\n\n")

# Temperature checks (from Heath 1974, Teo et al. 2021)
if ("bio5" %in% names(suitable_env)) {
  bio5_range <- range(suitable_env$bio5, na.rm = TRUE)
  cat(sprintf("Max temp warmest month (bio5) in suitable area: %.1f - %.1f °C\n",
              bio5_range[1], bio5_range[2]))
  cat(sprintf("  Expected upper limit: ~32-33°C (Heat stress threshold)\n"))
  cat(sprintf("  Check: %s\n\n",
              ifelse(bio5_range[2] <= 35, "PASS", "WARNING - exceeds expected limit")))
}

if ("bio6" %in% names(suitable_env)) {
  bio6_range <- range(suitable_env$bio6, na.rm = TRUE)
  cat(sprintf("Min temp coldest month (bio6) in suitable area: %.1f - %.1f °C\n",
              bio6_range[1], bio6_range[2]))
  cat(sprintf("  Expected lower limit: ~8°C (Developmental threshold)\n"))
  cat(sprintf("  Check: %s\n\n",
              ifelse(bio6_range[1] >= -2, "PASS - within reasonable range",
                     "WARNING - well below expected limit")))
}

if ("bio12" %in% names(suitable_env)) {
  bio12_range <- range(suitable_env$bio12, na.rm = TRUE)
  cat(sprintf("Annual precipitation (bio12) in suitable area: %.0f - %.0f mm\n",
              bio12_range[1], bio12_range[2]))
  cat(sprintf("  Expected: >500 mm (moisture requirement for off-host survival)\n\n"))
}

# --- Geographic range check ---
cat("Geographic extent of predicted suitable habitat:\n")
cat(sprintf("  Latitude: %.1f to %.1f S\n",
            abs(max(suitable_cells$y)), abs(min(suitable_cells$y))))
cat(sprintf("  Longitude: %.1f to %.1f E\n",
            min(suitable_cells$x), max(suitable_cells$x)))
cat("\n")
cat("Expected range (Teo et al. 2021):\n")
cat("  Coastal fringe from north QLD (~15°S) to eastern VIC (~38°S)\n")
cat("  Predominantly east of the Great Dividing Range\n")
```

## 11.1 Cross-Validation Performance Summary

```{r final-summary}
#| label: final-summary

cat("\n")
cat("===================================================\n")
cat("  FINAL MODEL PERFORMANCE SUMMARY\n")
cat("===================================================\n\n")

print(cv_summary, row.names = FALSE)

cat("\n")
cat("Ensemble weights:\n")
for (i in seq_along(algo_names)) {
  cat(sprintf("  %15s: %.3f\n", algo_names[i], weights[i]))
}
cat(sprintf("\nTSS threshold for binary map: %.3f\n", tss_result$threshold))
cat(sprintf("Number of occurrence records used: %d\n", sum(model_data$presence == 1)))
cat(sprintf("Number of background points used: %d\n", sum(model_data$presence == 0)))
cat(sprintf("Number of environmental predictors: %d\n", length(pred_cols)))
cat(sprintf("Predictors: %s\n", paste(pred_cols, collapse = ", ")))
```

# 12. Session Info

```{r session-info}
#| label: session-info

sessionInfo()
```
